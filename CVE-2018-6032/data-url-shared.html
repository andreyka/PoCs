<!DOCTYPE html>
<script src="resources/testharness.js"></script>
<script src="resources/testharnessreport.js"></script>
<script>
function openWindow(url) {
  return new Promise(resolve => {
    const win = window.open(url, '_blank');
    add_completion_callback(() => win.close());
    window.onmessage = e => {
      assert_equals(e.data, 'LOADED');
      resolve(win.postMessage.bind(win));
    };
  });
}

promise_test(() => {
  const kWindowURL = 'data-url-shared-window.html';
  const kRemoteWindowURL = "http://127.0.0.1:5000/data-url-shared-window.html/"; 
  return openWindow(kWindowURL) //allow popup windows to open window
    .then(win => {
        const channel = new MessageChannel;
        win(channel.port1, '*', [channel.port1]);
        return new Promise(resolve => channel.port2.onmessage = resolve);
      })
    .then(msg_event => {
        assert_equals(msg_event.data, 1);
        return openWindow(kRemoteWindowURL);
      })
    .then(win => {
        const channel = new MessageChannel;
        win(channel.port1, '*', [channel.port1]);
        return new Promise(resolve => channel.port2.onmessage = resolve);
      })
    .then(msg_event => assert_equals(msg_event.data, 1)); // we'll get 2 here if shared worker from another origin has access;
}, 'A data: URL shared worker should not be shared among origins.'); 
</script>
